<!DOCTYPE html>
<html xmlns:layout="http://www.w3.org/1999/xhtml" layout:decorate="~{layout/layout}">
<head>
	<title>[[${session.APP_NAME}]] - Violation</title>
</head>
<body>
<div layout:fragment="content" class="contant">
	<div class="pre-loading">
    	<img class="loader" src="/web/images/loader.png" />
  	</div>
      <div class="heading">
        <span class="heading-text fs-30">Violation</span>
    </div>
    <!-- <span>
        <button class="btn btn-outline-warning" onclick="back()">Go Back</button>
    </span> -->
    <div class="main-table">
    	<div class="col-md-12 pb-10 row m-0">
    		<div class="col-md-12">
				<div class="lens_select select_position">
					<div class="input-group date" id="datepicker">
						<input type="text" id="text-date" class="form-control">
						  <span class="input-group-append"> </span>
					 </div>
				 </div>
    			
    		</div>
    		<div class="col-md-12 row table-responsive">
    			<table class="clr-txt">
    				<thead>
    					<tr>
                            <th width="300"> ID </th>
                            <th width="300"> Name </th>
    						<th width="300"> Time </th>
    						<th width="300"> Type </th>
    						<th width="300"> Location</th>
    						<th width="300"> Snapshot </th>
    					</tr>
    				</thead>
    				<tbody class="" id="violationList"></tbody>
    			</table>
    		</div>
    	</div>
        <div id="popup_default" class="popup">
            <div class="popup-overlay"></div>
            <div class="popup-content">
              <a href="#" class="close-popup" data-id="popup_default">&times;</a>
             <table id="imageId">
                 
             </table>
          </div>
        </div>
    </div>
	<div class="records"></div>
<script>
	$(document).ready(function(){
		$("#violation").addClass('active');
		var date=new Date();
		UnknownRegistry(date);
		 
	})

  $(function() {
	$("#text-date").datetimepicker({
		toolbarPlacement: 'bottom',
		defaultDate: new Date(),
		format: 'YYYY-MM-DD',
		maxDate:new Date(),
      });
   
	  $("#text-date").on("dp.change", function (e) {
		var date=e.date.format(e.date._f)	
		var st1=date;
		var st2="T00:01:01.001Z";
		var date = st1.concat(st2);    
		UnknownRegistry(date);
    });
  });

  function UnknownRegistry(date){
		var reportApi = "[[${session.REPORT_API}]]";
		var sessionToken = "[[${session.USER.sessionToken}]]";
		var urlSlashCheck = reportApi.endsWith("/")?reportApi:reportApi+"/";
			var apiUrl = urlSlashCheck + "/api/v1/violation/access/getList"; 
			unknownFilterVO={
							date:date
							}
		var ilensApiClientVO  = {
			api: apiUrl,
			clientKey: sessionToken,
			inputVo: unknownFilterVO,
			method: "POST"
		}
		$("#violationList").empty();
			$.ajax({
			contentType: "application/json;charset=UTF-8",
			url: "api/v1/iLensApiClient",
			dataType: "json",
			headers:{'CLIENT_KEY':sessionToken},
			type: "POST",
			async: false,
			data: JSON.stringify(ilensApiClientVO),
			success: function(data){
				var violationList="";
				for(i=0;i<data.length;i++){
				var time = moment(data[i].time).format("DD-MM-YYYY hh:mm:ss A");
				encodedString = getSnapshotString(data[i].snapshot);
				if(encodedString.toString().length === 0){
                    encodedString = getSnapshotString("noImageAvailable");
                }
				violationList=violationList+'<tr>';
				violationList=violationList+'<td>' +data[i].id+ '</td>';
				violationList=violationList+'<td>'+data[i].name+'</td>';
				violationList=violationList+'<td>'+time +'</td>';
                violationList=violationList+'<td>'+data[i].location +'</td>';
                violationList=violationList+'<td>'+data[i].type +'</td>';
				violationList = violationList + '<td>';
				violationList = violationList + "<div class='image'>";
				violationList = violationList + "<a href='#' class='open-popup' id='" + encodedString +"' data-id='popup_default' onclick='snapshotShow(this.id)'> <img src='data:image/png;base64," + encodedString + "'></a>";
				violationList = violationList + "</div>";
				violationList = violationList + "</td>";
				violationList=violationList+'</tr>';
				}
				if(data==0){
					$(".records").html("No Records Found").show();
				}else{
					$("#violationList").html(violationList);
					$(".records").hide()
				}
				},

			error:function(err){
				console.log(err);
				}
			});
	}

    
	function getSnapshotString(snapshotValue){
		var bs64EncodedString = "";
    var reportApi = "[[${session.REPORT_API}]]";
    var sessionToken = "[[${session.USER.sessionToken}]]";
    var urlSlashCheck = reportApi.endsWith("/")?reportApi:reportApi+"/";
    var type="Registry"
    var apiUrl = urlSlashCheck + "api/v1/ilens/attendance/snapshot/"+snapshotValue+"/"+type; 
    var ilensApiClientVO  = {
        api: apiUrl,
        clientKey: sessionToken,
        inputVo: {},
        method: "GET"
      }
		$.ajax({
			contentType:"application/json;charset=UTF-8",
			url:"api/v1/iLensApiClient",
			headers:{'CLIENT_KEY':sessionToken},
            type: "POST",
            data: JSON.stringify(ilensApiClientVO),
            async:false,
            success:function(data){
            	bs64EncodedString = data;
            },
            error:function(err) {
            	console.log(err)
            }
		});
		return bs64EncodedString;
	}

	    // popup open and close.

	(function($) {
      $.fn.openPopup = function( settings ) {
        var elem = $(this);
        var settings = $.extend({
          anim: 'fade'
        }, settings);
        elem.show();
        elem.find('.popup-content').addClass(settings.anim+'In');
      }
      
      $.fn.closePopup = function( settings ) {
        var elem = $(this);
        var settings = $.extend({
          anim: 'fade'
        }, settings);
        elem.find('.popup-content').removeClass(settings.anim+'In').addClass(settings.anim+'Out');
        
        setTimeout(function(){
            elem.hide();
            elem.find('.popup-content').removeClass(settings.anim+'Out')
          }, 500);
      }
        
    }(jQuery));

	var imageId="";
    function snapshotShow(encodeString){
        imageId = imageId + "<img src='data:image/png;base64," + encodeString + "'>"
        $("#imageId").html(imageId);
        $('#popup_default').openPopup({ anim: 'fade' });
        imageId = "";
    }

     $('.close-popup').click(function(){
      $('#popup_default').closePopup({ anim: 'fade' });
    });

</script>

</div>
</body>
</html>